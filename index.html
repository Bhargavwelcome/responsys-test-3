<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsys Web Push Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f8fafc; color: #333; text-align: center; padding: 40px; }
    h1 { color: #0078d7; }
    .visitor { margin-top: 20px; font-size: 1.2em; }
  </style>

  <!-- Responsys Web Push SDK -->
  <script 
    type="text/javascript" 
    id="rsyswpsdk" 
    src="https://api.pushio.com/webpush/sdk/wpIndex_min.js" 
    wpconfig='{
      "appserviceKey":"BE_QYsSpUjlPflz66YjLtxez2s8Gl2PC91Ox_QHuHSWUOZLrYbrBmhZiuYBbLLLYGw-YsKpoq7Q0WdY74kfNIqY=",
      "apiKey":"ABEOzqUHvCM5ly5OJxkX7p6YY",
      "accountToken":"ABElKaqpK-3l_zDeOp-XArlkg",
      "appver":"1.0.0",
      "apiHost":"https://abr16c0-webpush.oraclersys.com",
      "lazy":false
    }'>
  </script>
</head>
<body>

  <h1>Responsys Web Push Demo</h1>
  <p class="visitor" id="visitorIdDisplay">Visitor ID will appear here after registration.</p>

  <script>
    async function initWebPush() {
      try {
        // 1Ô∏è‚É£ Register Service Worker
        if ('serviceWorker' in navigator) {
          const registration = await navigator.serviceWorker.register('webpush-service-worker.js');
          console.log('‚úÖ Service Worker registered:', registration);
        } else {
          console.warn('Service workers are not supported in this browser.');
          return;
        }

        // 2Ô∏è‚É£ Wait for Responsys SDK
        if (window.webPushManagerAPI && typeof webPushManagerAPI.getVisitorId === 'function') {
          const visitorId = await webPushManagerAPI.getVisitorId();
          console.log('Visitor ID:', visitorId);

          // Display it on screen
          document.getElementById('visitorIdDisplay').textContent = visitorId;

          // 3Ô∏è‚É£ Store Visitor ID persistently (localStorage)
          localStorage.setItem('responsysVisitorId', visitorId);
        } else {
          console.warn('webPushManagerAPI not ready yet. Retrying in 1s...');
          setTimeout(initWebPush, 1000); // retry after SDK loads
        }
      } catch (err) {
        console.error('‚ùå Web Push initialization failed:', err);
      }
    }

    // üîπ Restore existing visitor ID immediately (optional)
    const savedId = localStorage.getItem('responsysVisitorId');
    if (savedId) {
      document.getElementById('visitorIdDisplay').textContent = savedId + ' (cached)';
    }

    // üîπ Initialize after page load
    window.addEventListener('load', initWebPush);
  </script>

</body>
</html>
