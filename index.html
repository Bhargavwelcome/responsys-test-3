<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsys Web Push Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f8fafc; color: #333; text-align: center; padding: 40px; }
    h1 { color: #0078d7; }
    .visitor { margin-top: 20px; font-size: 1.2em; }
  </style>

  <!-- Load Responsys Web Push SDK -->
  <script 
    type="text/javascript" 
    id="rsyswpsdk" 
    src="https://api.pushio.com/webpush/sdk/wpIndex_min.js" 
    wpconfig='{
      "appserviceKey":"BE_QYsSpUjlPflz66YjLtxez2s8Gl2PC91Ox_QHuHSWUOZLrYbrBmhZiuYBbLLLYGw-YsKpoq7Q0WdY74kfNIqY=",
      "apiKey":"ABEOzqUHvCM5ly5OJxkX7p6YY",
      "accountToken":"ABElKaqpK-3l_zDeOp-XArlkg",
      "appver":"0.0.0",
      "apiHost":"https://abr16c0-webpush.oraclersys.com",
      "lazy":false
    }'>
  </script>
</head>
<body>

  <h1>Responsys Web Push Demo</h1>
  <p class="visitor" id="visitorIdDisplay">Visitor ID will appear here after registration.</p>

  <script>
    async function initWebPush() {
      try {
        // Register your service worker
        if ('serviceWorker' in navigator) {
          const registration = await navigator.serviceWorker.register('webpush-service-worker.js');
          console.log('Service Worker registered:', registration);

          // Wait for the SDK to initialize and get the visitor ID
          if (window.webPushManagerAPI && typeof webPushManagerAPI.getVisitorId === 'function') {
            const visitorId = await webPushManagerAPI.getVisitorId();
            console.log('Visitor ID:', visitorId);
            document.getElementById('visitorIdDisplay').textContent = visitorId;
          } else {
            console.warn('webPushManagerAPI is not available yet.');
          }
        } else {
          console.warn('Service workers are not supported in this browser.');
        }
      } catch (err) {
        console.error('Web Push initialization failed:', err);
      }
    }

    // Clear any old IndexedDB for clean initialization (optional but prevents object store errors)
    function clearOldDB() {
      if (window.indexedDB) {
        const DBDeleteRequest = indexedDB.deleteDatabase('WebPushDB');
        DBDeleteRequest.onsuccess = () => console.log('Old IndexedDB cleared.');
        DBDeleteRequest.onerror = () => console.warn('Failed to clear old IndexedDB.');
      }
    }

    // Initialize
    clearOldDB();
    window.addEventListener('load', initWebPush);
  </script>

</body>
</html>
